<!DOCTYPE HTML>
<html>

<head>
    <title>Autoreload V3.5</title>
    <script type="text/javascript" src="v3.5.js"></script>
</head>

<body style="background: black;">
    <script>
        // format: http://kiwi.com:8073/
        const kiwilistDay = ["http://kiwi4.com:8073/",
            "http://kiwi5.com:8073/",
        ];
        const kiwilistNight = ["http://kiwi0.com:8073/", ,
            "http://kiwi1.com:8073/",
            "http://kiwi2.com:8073/",
        ];

        function tune(url) {
            console.log(`loading ${url}`);
            let freq = "4625usb";
            let mode = "usb";
            let zoom = "11";
            let startPass = "50";
            let endPass = "4000";
            let colormap = "1";
            let volume = "180";

            document.getElementById("overlay").style.display = "block";
            document.getElementById("kiwiframe").src = `${url}?f=${freq}z${zoom}&pb=${startPass},${endPass}&cmap=${colormap}&vol=${volume}`;
            setTimeout(() => { document.getElementById("overlay").style.display = "none"; }, 15 * 1000);
        }

        const kiwimapDay = initAutoreloadMap(kiwilistDay);
        const kiwimapNight = initAutoreloadMap(kiwilistNight);

        const config = {
            timeout: 2000, // timeout when probing kiwi - in milliseconds
            scoreSNRMult: 1, // SNR score multiplier
            scoreUsageMult: 20, // usage score multiplier (usage is value 0 - 1 1 being lowest usage)
            scoreTimeMult: 1, // time score multiplier (time is minutes passed since SDR last used)
        };

        async function reload() {
            let utcHour = new Date().getUTCHours();
            let kiwimap = null;
            if ((utcHour >= 5) && (utcHour < 18)) {
                kiwimap = kiwimapDay;
            } else {
                kiwimap = kiwimapNight;
            }

            let url = await getBestKiwi(config, kiwimap);
            document.getElementById("versiontext").innerHTML = "Autoreload V3.5";
            if (url == null) {
                document.getElementById("versiontext").innerHTML = "Autoreload V3.5<br>Error: No SDR found";
                return;
            }
            let e = kiwimap.get(url);
            e.lastused = Date.now() / 60000;
            kiwimap.set(url, e);
            tune(url);
        }

        reload(); // we call it ourselves the first time since setInterval waits for interval before first run
        setInterval(reload, 5 * 60000);
    </script>
    <iframe src="" id="kiwiframe"
        style="position: fixed; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%; border: none; margin: 0; padding: 0; overflow: hidden; z-index:1;">
        Your browser doesn't support iframes
    </iframe>
    <div id="overlay"
        style="display:none; position: fixed; z-index:2; background: black; width: 100%; height: 100%; top: 0; left: 0; bottom: 0; right: 0;">
        <h1 style="text-align: center; position: absolute; top: 50%; bottom: 50%; width: 100%; color: green;">
            Loading SDR
        </h1>
    </div>

    <h1 id="versiontext" style="text-align: center; position: fixed; top: 50%; bottom: 50%; width: 100%; color: red;">
        Autoreload V3.5
    </h1>
</body>

</html>
